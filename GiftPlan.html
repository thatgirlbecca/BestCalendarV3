<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiftPlan</title>
    <link rel="icon" type="image/png" href="BestCalendarV3Favicon3.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="GiftPlan.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    <script src="GiftPlan.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" style="display: none;">
        <div class="login-container">
            <h1>GiftPlan Login</h1>
            <form id="login-form" onsubmit="handleLogin(event)">
                <label for="login-email"><b>Email</b></label>
                <input type="email" id="login-email" placeholder="Enter your email" required autofocus autocomplete="off">
                <label for="login-password"><b>Password</b></label>
                <input type="password" id="login-password" placeholder="Enter password" required autocomplete="off">
                <button type="submit" class="btn-login">Login</button>
                <div id="login-error" class="login-error" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- GiftPlan App -->
    <div id="giftplan-app" style="display: none;">
        <div id="giftplan-header">
            <div class="giftplan-header-flex">
                <div class="header-left">
                    <h1 class="header-logo">üéÅ Gift Plan</h1>
                    <div class="view-tabs">
                        <button class="view-tab active" data-view="people" onclick="switchView('people')">People View</button>
                        <button class="view-tab" data-view="yearplan" onclick="switchView('yearplan')">Year Plan View</button>
                    </div>
                </div>
                <div class="header-buttons">
                    <select class="nav-dropdown" onchange="handleNavigation(this)" title="Navigate">
                        <option value="index.html">üìÖ Calendar</option>
                        <option value="todo.html">üìù Todos</option>
                        <option value="grocery.html">üõí Grocery</option>
                        <option value="GiftPlan.html" selected>üéÅ GiftPlan</option>
                    </select>
                    <button id="logout-button" class="logout-button" onclick="handleLogout()" title="Logout">‚õî</button>
                </div>
            </div>
        </div>
        <main>
            <!-- People View -->
            <div id="people-view" class="view-container giftplan-3col">
                <!-- People Sidebar -->
                <aside id="people-sidebar">
                    <div class="sidebar-header">
                        <span>People</span>
                        <button id="add-person-btn" title="Add Person">+</button>
                    </div>
                    <ul id="people-list"></ul>
                    <button id="toggle-archived-btn" class="toggle-archived-btn" onclick="toggleArchivedSection()">Archived ‚ñº</button>
                    <ul id="archived-people-list" class="archived-list" style="display: none;"></ul>
                </aside>
                <!-- Gift Ideas Column -->
                <section id="gift-plan-section">
                    <div class="giftplan-condensed-header">
                        <span id="gift-plan-title">üí° Gift Ideas for <span id="selected-person-name">Select a Person</span></span>
                        <label class="condensed-toggle-label">
                            <input type="checkbox" id="show-all-years-toggle" onchange="handleYearFilterChange()">
                            <span>Show All Years</span>
                        </label>
                        <span id="gift-plan-total">Potential: $0.00</span>
                        <button id="add-gift-btn" title="Add Gift Idea">+</button>
                    </div>
                    <div id="gift-boxes-container"></div>
                </section>
                <!-- Stats & Given/Received Column -->
                <section id="stats-section">
                    <div id="stats-container">
                        <!-- Stats will be rendered here -->
                    </div>
                    <div id="given-received-columns">
                        <div id="gifts-given-section-people" class="gift-column">
                            <div class="gift-column-header">
                                <span>üéÅ Given To</span>
                                <button class="add-gift-column-btn" title="Add Given Gift" onclick="openAddGivenGiftModal()">+</button>
                            </div>
                            <div id="gifts-given-list"></div>
                            <div id="gifts-given-total" class="gift-column-total">Total Spent: $0.00</div>
                        </div>
                        <div id="gifts-received-section-people" class="gift-column">
                            <div class="gift-column-header">
                                <span>üéÅ Received From</span>
                                <button class="add-gift-column-btn" title="Add Received Gift" onclick="openAddReceivedGiftModal()">+</button>
                            </div>
                            <div id="gifts-received-list"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Year Plan View -->
            <div id="yearplan-view" class="view-container" style="display: none;">
                <div class="yearplan-bar-wrapper">
                  <div class="yearplan-bar">
                      <div class="yearplan-bar-section">
                          <label for="yearplan-year-select">Year:</label>
                          <select id="yearplan-year-select" onchange="handleYearPlanYearChange()"></select>
                      </div>
                      <div class="yearplan-bar-section">
                          <span id="yearplan-spent">Total Spent: $0.00</span>
                      </div>
                  </div>
                </div>
                <div class="yearplan-2col">
                    <section id="yearplan-given">
                        <div class="section-header">
                            <span>üéÅ Gifts Given</span>
                            <button id="yearplan-add-given" title="Add Gift" onclick="openYearPlanGiftModal('given')">+</button>
                        </div>
                        <div id="yearplan-given-list"></div>
                    </section>
                    <section id="yearplan-received">
                        <div class="section-header">
                            <span>üéÅ Gifts Received</span>
                            <button id="yearplan-add-received" title="Add Received Gift" onclick="openYearPlanGiftModal('received')">+</button>
                        </div>
                        <div id="yearplan-received-list"></div>
                    </section>
                </div>
            </div>

            <!-- Modals -->
            <div id="modal-overlay" class="modal-overlay" style="display:none;"></div>
            
            <!-- Person Modal -->
            <div id="person-modal" class="modal" style="display:none;">
                <form id="person-form">
                    <h2 id="person-modal-title">Add Person</h2>
                    <label>Name</label>
                    <input type="text" id="person-name" required autocomplete="off">
                    <label>Birthday (MM/DD) - Optional</label>
                    <input type="text" id="person-birthday" placeholder="MM/DD" autocomplete="off">
                    <div class="modal-actions">
                        <button type="submit">Save</button>
                        <button type="button" onclick="closePersonModal()">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- Person Summary Modal -->
            <div id="person-summary-modal" class="modal" style="display:none; min-width:340px;">
                <div id="person-summary-content">
                    <h2 id="person-summary-title">Person Summary</h2>
                    <form id="person-summary-form">
                        <div id="person-summary-info">
                            <!-- Populated by JS -->
                        </div>
                        <div id="person-summary-edit-fields" style="display:none;">
                            <label for="person-edit-name">Name</label>
                            <input type="text" id="person-edit-name" required autocomplete="off">
                            <label for="person-edit-birthday">Birthday (MM/DD)</label>
                            <input type="text" id="person-edit-birthday" placeholder="MM/DD" autocomplete="off">
                            <label for="person-edit-notes">Notes</label>
                            <textarea id="person-edit-notes" rows="4" style="width:100%;"></textarea>
                        </div>
                        <div class="modal-actions">
                            <button id="edit-person-btn" type="button">Edit</button>
                            <button id="save-person-edit-btn" type="submit" style="display:none;">Save</button>
                            <button id="cancel-person-edit-btn" type="button" style="display:none;">Cancel</button>
                            <button type="button" onclick="closePersonSummaryModal()">Close</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Gift Modal (Add/Edit Given Gift) -->
            <div id="gift-modal" class="modal" style="display:none;">
                <form id="gift-form">
                    <h2 id="gift-modal-title">Add Gift</h2>
                    
                    <div id="gift-person-row" class="modal-row">
                        <label>Gift for:</label>
                        <select id="gift-person-select">
                            <option value="">Select Person</option>
                        </select>
                        <button type="button" id="add-person-from-gift" onclick="openPersonFromGiftModal()">+ New Person</button>
                    </div>
                    
                    <label>Item</label>
                    <input type="text" id="gift-item" required autocomplete="off">
                    
                    <label>Occasion</label>
                    <select id="gift-occasion">
                        <option value="">Anytime</option>
                        <option value="christmas">Christmas</option>
                        <option value="birthday">Birthday</option>
                        <option value="valentines">Valentine's Day</option>
                        <option value="anniversary">Anniversary</option>
                        <option value="mothersday">Mother's Day</option>
                        <option value="fathersday">Father's Day</option>
                        <option value="easter">Easter</option>
                        <option value="graduation">Graduation</option>
                        <option value="other">Other</option>
                    </select>
                    
                    <div id="gift-store-row">
                        <label>Store</label>
                        <input type="text" id="gift-store" autocomplete="off">
                    </div>
                    
                    <div id="gift-cost-row">
                        <label>Cost</label>
                        <input type="number" id="gift-cost" min="0" step="0.01" autocomplete="off">
                    </div>
                    
                    <div id="gift-priority-row">
                        <label>Priority</label>
                        <select id="gift-priority">
                            <option value="none">None</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    
                    <label>Year</label>
                    <select id="gift-year">
                        <option value="">Anytime (No Year)</option>
                    </select>
                    
                    <div id="gift-type-row" style="display:block;">
                        <label>Type</label>
                        <select id="gift-type">
                            <option value="idea">üí° Gift Idea</option>
                            <option value="given">üéÅ Gift to Give</option>
                            <option value="received">üì¶ Gift Received</option>
                        </select>
                    </div>
                    
                    <label>Notes</label>
                    <textarea id="gift-notes"></textarea>
                    
                    <div id="gift-modal-info" class="modal-info" style="display:none;">
                        <span id="gift-year-display"></span>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit">Save</button>
                        <button type="button" onclick="closeGiftModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
    // Show/hide GiftPlan app based on login
    function showGiftPlan() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('giftplan-app').style.display = 'block';
    }
    function showLoginGiftPlan() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('giftplan-app').style.display = 'none';
    }
    async function checkGiftPlanAuthOnLoad() {
        await new Promise(resolve => setTimeout(resolve, 100));
        const authenticated = await isAuthenticated();
        if (authenticated) {
            showGiftPlan();
        } else {
            showLoginGiftPlan();
        }
    }
    window.addEventListener('DOMContentLoaded', checkGiftPlanAuthOnLoad);
    // Override showCalendar/showLogin for this page
    window.showCalendar = showGiftPlan;
    window.showLogin = showLoginGiftPlan;
    </script>
</body>
</html>
